<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ilija â€“ Public Edition</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080C0A;--bg2:#0E1410;--bg3:#141C17;--bg4:#1A2420;
  --border:#1E2E28;--border2:#2A3E36;
  --green:#00C87A;--green2:#00A362;--green3:#004D2F;
  --greenDim:rgba(0,200,122,.07);
  --text:#E8F4EF;--text2:#8BA99A;--text3:#506860;
  --red:#FF4757;--warn:#F5A623;
  --font:'Syne',sans-serif;--mono:'JetBrains Mono',monospace;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* Header */
.header{display:flex;align-items:center;gap:12px;padding:0 20px;height:54px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0}
.logo{width:32px;height:32px;background:var(--green);border-radius:8px;display:grid;place-items:center;font-weight:800;font-size:15px;color:var(--bg);flex-shrink:0}
.logo-text{font-weight:800;font-size:.95rem;letter-spacing:.02em}
.logo-text em{font-style:normal;color:var(--green);margin-left:2px}
.header-actions{margin-left:auto;display:flex;gap:6px;align-items:center}
.badge-provider{font-family:var(--mono);font-size:.7rem;padding:4px 10px;background:var(--bg3);border:1px solid var(--border2);border-radius:20px;color:var(--green)}
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:6px;font-family:var(--font);font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s;border:none;letter-spacing:.02em}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border2)}
.btn-ghost:hover{background:var(--bg3);color:var(--text);border-color:var(--green)}
.nav-link{color:var(--text2);font-size:.8rem;font-weight:600;text-decoration:none;padding:5px 10px;border-radius:6px;transition:all .15s}
.nav-link:hover{background:var(--greenDim);color:var(--green)}

/* Chat area */
.chat-area{flex:1;overflow-y:auto;padding:24px 20px;display:flex;flex-direction:column;gap:16px}
.chat-area::-webkit-scrollbar{width:3px}
.chat-area::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* Welcome */
.welcome{text-align:center;padding:40px 20px;max-width:560px;margin:auto}
.welcome .w-icon{font-size:3rem;margin-bottom:16px}
.welcome h1{font-size:1.6rem;font-weight:800;margin-bottom:8px}
.welcome h1 span{color:var(--green)}
.welcome p{color:var(--text2);font-size:.88rem;line-height:1.7;margin-bottom:24px}
.chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.chip{padding:8px 14px;background:var(--bg2);border:1px solid var(--border2);border-radius:20px;font-size:.78rem;cursor:pointer;transition:all .15s;color:var(--text2)}
.chip:hover{background:var(--greenDim);border-color:var(--green);color:var(--green)}

/* Messages */
.msg{display:flex;gap:10px;animation:msgIn .2s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg.user{flex-direction:row-reverse}
.msg-avatar{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;font-size:13px;flex-shrink:0;align-self:flex-end}
.msg.assistant .msg-avatar{background:var(--green);color:var(--bg);font-weight:800}
.msg.user .msg-avatar{background:var(--bg4);border:1px solid var(--border2);color:var(--text2)}
.msg-bubble{max-width:72%;padding:12px 16px;border-radius:14px;font-size:.88rem;line-height:1.7}
.msg.assistant .msg-bubble{background:var(--bg2);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg.user .msg-bubble{background:var(--green3);border:1px solid var(--green);border-bottom-right-radius:4px;color:var(--text)}
.msg-bubble code{font-family:var(--mono);font-size:.8rem;background:var(--bg4);padding:2px 6px;border-radius:4px;color:var(--green)}
.msg-bubble pre{background:var(--bg4);padding:12px;border-radius:8px;overflow-x:auto;margin:8px 0}
.msg-bubble pre code{background:none;padding:0}
.msg-time{font-size:.65rem;color:var(--text3);margin-top:4px;font-family:var(--mono);align-self:flex-end;flex-shrink:0}

/* Typing indicator */
.typing{display:flex;gap:4px;padding:14px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;border-bottom-left-radius:4px;width:fit-content}
.typing span{width:6px;height:6px;background:var(--green);border-radius:50%;animation:blink 1.2s ease infinite}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

/* Input area */
.input-area{padding:16px 20px;background:var(--bg2);border-top:1px solid var(--border);flex-shrink:0}
.input-wrap{display:flex;gap:8px;align-items:flex-end;background:var(--bg3);border:1px solid var(--border2);border-radius:12px;padding:8px 12px;transition:border-color .15s}
.input-wrap:focus-within{border-color:var(--green)}
.input-wrap textarea{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:.88rem;resize:none;max-height:140px;min-height:24px;line-height:1.5}
.input-wrap textarea::placeholder{color:var(--text3)}
.input-controls{display:flex;gap:6px;align-items:center;flex-shrink:0}
.icon-btn{width:34px;height:34px;border-radius:8px;border:none;background:transparent;color:var(--text3);cursor:pointer;display:grid;place-items:center;font-size:16px;transition:all .15s}
.icon-btn:hover{background:var(--bg4);color:var(--text)}
.send-btn{width:34px;height:34px;border-radius:8px;border:none;background:var(--green);color:var(--bg);cursor:pointer;display:grid;place-items:center;font-size:16px;transition:all .15s;font-weight:700}
.send-btn:hover{background:var(--green2);transform:scale(1.05)}
.send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.input-hint{font-size:.7rem;color:var(--text3);margin-top:6px;font-family:var(--mono)}

/* File upload */
#fileInput{display:none}
</style>
</head>
<body>

<header class="header">
  <div class="logo">I</div>
  <span class="logo-text">Ilija<em>PE</em></span>
  <div style="width:1px;height:24px;background:var(--border);margin:0 4px"></div>
  <a href="/dms" class="nav-link">ğŸ—‚ DMS</a>
  <div class="header-actions">
    <span class="badge-provider" id="providerBadge">â€“</span>
    <button class="btn btn-ghost" onclick="reloadSkills()">â†º Reload</button>
    <button class="btn btn-ghost" onclick="clearChat()">âœ• Clear</button>
  </div>
</header>

<div class="chat-area" id="chatArea">
  <div class="welcome" id="welcomeScreen">
    <div class="w-icon">ğŸ¤–</div>
    <h1>Hallo, ich bin <span>Ilija</span></h1>
    <p>Dein persÃ¶nlicher KI-Assistent fÃ¼r Kommunikation, Organisation und Dokumentenverwaltung.</p>
    <div class="chips">
      <div class="chip" onclick="sendChip('Dokumente einsortieren')">ğŸ“ Dokumente einsortieren</div>
      <div class="chip" onclick="sendChip('Was ist das aktuelle Datum?')">ğŸ“… Datum & Uhrzeit</div>
      <div class="chip" onclick="sendChip('Zeig mir den WhatsApp-Kalender')">ğŸ’¬ WhatsApp-Kalender</div>
      <div class="chip" onclick="sendChip('Suche nach: KÃ¼nstliche Intelligenz')">ğŸ” Internet-Suche</div>
      <div class="chip" onclick="sendChip('Was weiÃŸt du Ã¼ber mich?')">ğŸ§  GedÃ¤chtnis abrufen</div>
      <div class="chip" onclick="sendChip('Wie viele Dokumente sind im Archiv?')">ğŸ“Š Archiv-Status</div>
    </div>
  </div>
</div>

<div class="input-area">
  <div class="input-wrap">
    <textarea id="msgInput" placeholder="Schreib etwas..." rows="1"
      onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <div class="input-controls">
      <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Datei hochladen">ğŸ“</button>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
    </div>
  </div>
  <div class="input-hint">Enter zum Senden Â· Shift+Enter fÃ¼r Zeilenumbruch Â· ğŸ“ Datei in DMS-Import senden</div>
  <input type="file" id="fileInput" multiple onchange="uploadFiles(this.files)">
</div>

<script>
let isLoading = false;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("DOMContentLoaded", () => {
  loadStatus();
  document.getElementById("msgInput").focus();
});

async function loadStatus() {
  try {
    const r = await fetch("/api/status");
    const d = await r.json();
    document.getElementById("providerBadge").textContent = d.active_provider || "â€“";
  } catch (e) {}
}

// â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleKey(e) {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = "auto";
  el.style.height = Math.min(el.scrollHeight, 140) + "px";
}

async function sendMessage() {
  const input = document.getElementById("msgInput");
  const msg   = input.value.trim();
  if (!msg || isLoading) return;

  hideWelcome();
  appendMsg("user", msg);
  input.value = "";
  input.style.height = "auto";

  const typing = appendTyping();
  setLoading(true);

  try {
    const r = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: msg }),
    });
    const d = await r.json();
    typing.remove();
    appendMsg("assistant", d.response || d.error || "Keine Antwort");
    document.getElementById("providerBadge").textContent = d.provider || "â€“";
  } catch (e) {
    typing.remove();
    appendMsg("assistant", "âŒ Verbindungsfehler. LÃ¤uft der Server?");
  }

  setLoading(false);
  scrollDown();
}

function sendChip(text) {
  document.getElementById("msgInput").value = text;
  sendMessage();
}

// â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideWelcome() {
  const w = document.getElementById("welcomeScreen");
  if (w) w.remove();
}

function appendMsg(role, text) {
  const area    = document.getElementById("chatArea");
  const wrapper = document.createElement("div");
  wrapper.className = `msg ${role}`;

  const now     = new Date().toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });
  const avatar  = role === "assistant" ? "I" : "ğŸ‘¤";
  const content = formatText(text);

  wrapper.innerHTML = `
    <div class="msg-avatar">${avatar}</div>
    <div>
      <div class="msg-bubble">${content}</div>
      <div class="msg-time">${now}</div>
    </div>
  `;
  area.appendChild(wrapper);
  scrollDown();
  return wrapper;
}

function appendTyping() {
  const area    = document.getElementById("chatArea");
  const wrapper = document.createElement("div");
  wrapper.className = "msg assistant";
  wrapper.innerHTML = `
    <div class="msg-avatar">I</div>
    <div class="typing"><span></span><span></span><span></span></div>
  `;
  area.appendChild(wrapper);
  scrollDown();
  return wrapper;
}

function formatText(text) {
  // Einfaches Markdown-Ã¤hnliches Formatting
  return text
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/`([^`]+)`/g, "<code>$1</code>")
    .replace(/\n/g, "<br>");
}

function scrollDown() {
  const area = document.getElementById("chatArea");
  area.scrollTop = area.scrollHeight;
}

function setLoading(val) {
  isLoading = val;
  document.getElementById("sendBtn").disabled = val;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function reloadSkills() {
  try {
    const r = await fetch("/api/reload", { method: "POST" });
    const d = await r.json();
    appendMsg("assistant", `ğŸ”„ ${d.message}`);
    hideWelcome();
  } catch (e) { appendMsg("assistant", "âŒ Reload fehlgeschlagen"); }
}

async function clearChat() {
  try {
    await fetch("/api/clear", { method: "POST" });
    document.getElementById("chatArea").innerHTML =
      `<div class="welcome" id="welcomeScreen">
        <div class="w-icon">âœ¨</div>
        <h1>Chat <span>geleert</span></h1>
        <p>Neues GesprÃ¤ch kann beginnen.</p>
       </div>`;
  } catch (e) {}
}

async function uploadFiles(files) {
  if (!files.length) return;
  const fd = new FormData();
  Array.from(files).forEach(f => fd.append("files", f));
  try {
    const r = await fetch("/api/dms/upload", { method: "POST", body: fd });
    const d = await r.json();
    hideWelcome();
    appendMsg("assistant",
      `ğŸ“¥ **${d.anzahl}** Datei(en) in DMS-Import gespeichert.\n` +
      `Sage "Dokumente einsortieren" um sie zu archivieren.`
    );
  } catch (e) {
    appendMsg("assistant", "âŒ Upload fehlgeschlagen.");
  }
  document.getElementById("fileInput").value = "";
}
</script>
</body>
</html>
